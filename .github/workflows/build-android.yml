name: Build Android APK

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Source
        uses: actions/checkout@v3

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y imagemagick

      - name: Install NPM Dependencies
        run: |
          npm install --legacy-peer-deps

      - name: Build Web App
        run: npm run build
        env:
          CI: false

      # ---------------------------------------------------------
      # Antigravity Step: Reinvigorate Android Project
      # ---------------------------------------------------------
      - name: Generate Android Project
        run: |
           # 1. Start Fresh: Remove existing android folder to avoid conflicts
           rm -rf android
           
           # 2. Add Android Platform
           echo "Adding Android platform..."
           npx cap add android
           
           # 3. Sync Web Assets
           echo "Syncing assets..."
           npx cap sync android

           # 4. Inject Firebase Config (Critical for Notifications)
           if [ -f google-services.json ]; then
             echo "Found google-services.json, injecting into Android project..."
             cp google-services.json android/app/
           else
             echo "::warning::google-services.json NOT FOUND! Notifications will NOT work."
           fi

      # ---------------------------------------------------------
      # Antigravity Step: Inject Icons & Permissions (The Fix)
      # ---------------------------------------------------------
      - name: Inject Custom Icons & Configure Manifest
        run: |
          # A. Validate Source Icon
          if [ ! -f resources/icon.png ]; then
            echo "::error::resources/icon.png not found! Please upload your icon."
            exit 1
          fi

          echo "Found source icon, starting processing..."

          # B. Remove Adaptive Icon Config (The 'Red Icon' Fix)
          # Deleting this folder forces Android to use the standard PNGs we generate below
          rm -rf android/app/src/main/res/mipmap-anydpi-v26

          # C. Generate Icons for all Densities using ImageMagick
          # Function to resize and copy
          generate_icon() {
            res_name=$1
            px_size=$2
            target_dir="android/app/src/main/res/mipmap-$res_name"
            
            echo "Generating $res_name ($px_size x $px_size)..."
            mkdir -p $target_dir
            
            # Generate Standard Icon
            convert resources/icon.png -resize ${px_size}x${px_size} $target_dir/ic_launcher.png
            # Generate Round Icon
            convert resources/icon.png -resize ${px_size}x${px_size} $target_dir/ic_launcher_round.png
          }

          generate_icon "mdpi" "48"
          generate_icon "hdpi" "72"
          generate_icon "xhdpi" "96"
          generate_icon "xxhdpi" "144"
          generate_icon "xxxhdpi" "192"

          echo "✅ Icons injected successfully."

          # E. Generate Notification Icon (White silhouette for status bar)
          echo "Generating notification icon..."
          
          # Function to create white notification icon
          generate_notification_icon() {
            res_name=$1
            px_size=$2
            target_dir="android/app/src/main/res/drawable-$res_name"
            
            mkdir -p $target_dir
            
            # Create a white silhouette notification icon
            # 1. Take the source icon
            # 2. Convert to grayscale
            # 3. Threshold to create silhouette
            # 4. Colorize to white
            # 5. Make background transparent
            convert resources/icon.png \
              -resize ${px_size}x${px_size} \
              -colorspace Gray \
              -threshold 50% \
              -negate \
              -fuzz 10% \
              -transparent black \
              -fill white \
              -opaque white \
              $target_dir/ic_stat_onesignal_default.png
          }
          
          generate_notification_icon "mdpi" "24"
          generate_notification_icon "hdpi" "36"
          generate_notification_icon "xhdpi" "48"
          generate_notification_icon "xxhdpi" "72"
          generate_notification_icon "xxxhdpi" "96"
          
          echo "✅ Notification icon injected successfully."

          # D. Update AndroidManifest.xml
          MANIFEST="android/app/src/main/AndroidManifest.xml"
          
          echo "Updating Manifest permissions and icon references..."
          
          # 1. Force icon references (just in case)
          sed -i 's/android:icon="[^"]*"/android:icon="@mipmap\/ic_launcher"/' $MANIFEST
          sed -i 's/android:roundIcon="[^"]*"/android:roundIcon="@mipmap\/ic_launcher_round"/' $MANIFEST
          
          # 2. Re-inject Permissions (Camera + Notifications)
          # Insert CAMERA and POST_NOTIFICATIONS permissions right after INTERNET permission
          sed -i '/android.permission.INTERNET/a \    <uses-permission android:name="android.permission.CAMERA" />\n    <uses-permission android:name="android.permission.POST_NOTIFICATIONS" />' $MANIFEST

          # 3. Allow Cleartext Traffic (Fix for Login Error 2)
          # Injects android:usesCleartextTraffic="true" into the <application> tag
          sed -i 's/<application/<application android:usesCleartextTraffic="true"/' $MANIFEST

      # ---------------------------------------------------------
      # Build Steps
      # ---------------------------------------------------------
      - name: Fix Gradle Wrapper Version
        working-directory: android
        run: |
          sed -i 's|distributionUrl=.*|distributionUrl=https\\://services.gradle.org/distributions/gradle-8.5-bin.zip|g' gradle/wrapper/gradle-wrapper.properties

      - name: Build Debug APK
        working-directory: android
        run: |
          chmod +x gradlew
          ./gradlew assembleDebug --stacktrace --warning-mode all

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: mouna-app-debug-fixed
          path: android/app/build/outputs/apk/debug/app-debug.apk
